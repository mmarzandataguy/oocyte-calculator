<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oocyte Vitrification Calculator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.5.0/dist/Recharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } = Recharts;

        const OocyteCalculator = () => {
          const [age, setAge] = useState(35);
          const [miiOocytes, setMiiOocytes] = useState(15);
          const [simulations] = useState(10000);
          const [selectedStudy, setSelectedStudy] = useState('namath');

          const studyParameters = {
            cobo: {
              name: "Cobo et al. 2016",
              getParams: (age) => ({
                survivalRate: 0.852,
                fertilizationRate: 0.70,
                blastRate: 0.45,
                livebirthPerTransfer: age <= 35 ? 0.316 : age <= 37 ? 0.25 : age <= 40 ? 0.18 : 0.12,
                usePGTA: false
              })
            },
            doyle: {
              name: "Doyle et al. 2016",
              getParams: (age) => ({
                survivalRate: 0.85,
                fertilizationRate: 0.72,
                blastRate: 0.50,
                livebirthPerTransfer: age < 35 ? 0.35 : age <= 37 ? 0.28 : age <= 40 ? 0.20 : 0.12,
                usePGTA: false
              })
            },
            goldman: {
              name: "Goldman et al. 2017",
              getParams: (age) => ({
                survivalRate: 0.88,
                fertilizationRate: 0.75,
                blastRate: 0.48,
                livebirthPerTransfer: age < 35 ? 0.33 : age <= 37 ? 0.27 : age <= 40 ? 0.19 : 0.13,
                usePGTA: false
              })
            },
            namath: {
              name: "Namath et al. 2025",
              getParams: (age) => ({
                survivalRate: 0.90,
                fertilizationRate: 0.70,
                blastRate: age < 35 ? 0.50 : age <= 37 ? 0.45 : age <= 40 ? 0.35 : age <= 42 ? 0.25 : 0.18,
                euploidRate: age < 35 ? 0.65 : age <= 37 ? 0.55 : age <= 40 ? 0.40 : age <= 42 ? 0.25 : 0.15,
                livebirthPerEuploid: 0.65,
                usePGTA: true
              })
            }
          };

          const runMonteCarloSimulation = (age, miiCount, study, numSimulations) => {
            const params = studyParameters[study].getParams(age);
            const results = [];
            
            for (let sim = 0; sim < numSimulations; sim++) {
              let survivedOocytes = 0;
              for (let i = 0; i < miiCount; i++) {
                if (Math.random() < params.survivalRate) survivedOocytes++;
              }
              
              let fertilizedOocytes = 0;
              for (let i = 0; i < survivedOocytes; i++) {
                if (Math.random() < params.fertilizationRate) fertilizedOocytes++;
              }
              
              let blastocysts = 0;
              for (let i = 0; i < fertilizedOocytes; i++) {
                if (Math.random() < params.blastRate) blastocysts++;
              }
              
              let transferableEmbryos = blastocysts;
              let lbRate = params.livebirthPerTransfer;
              
              if (params.usePGTA) {
                transferableEmbryos = 0;
                for (let i = 0; i < blastocysts; i++) {
                  if (Math.random() < params.euploidRate) transferableEmbryos++;
                }
                lbRate = params.livebirthPerEuploid;
              }
              
              let liveBirths = 0;
              for (let i = 0; i < transferableEmbryos; i++) {
                if (Math.random() < lbRate) liveBirths++;
              }
              
              results.push(liveBirths);
            }
            
            return results;
          };

          const simulationResults = useMemo(() => {
            const results = runMonteCarloSimulation(age, miiOocytes, selectedStudy, simulations);
            
            const totalSims = results.length;
            const prob1Plus = results.filter(r => r >= 1).length / totalSims;
            const prob2Plus = results.filter(r => r >= 2).length / totalSims;
            const prob3Plus = results.filter(r => r >= 3).length / totalSims;
            
            const distribution = [];
            for (let i = 0; i <= Math.min(Math.max(...results), 5); i++) {
              const count = results.filter(r => i === 5 ? r >= 5 : r === i).length;
              distribution.push({
                births: i === 5 ? '5+' : i.toString(),
                percentage: (count / totalSims * 100).toFixed(1)
              });
            }
            
            const sortedResults = [...results].sort((a, b) => a - b);
            const mean = results.reduce((a, b) => a + b, 0) / totalSims;
            const median = sortedResults[Math.floor(totalSims / 2)];
            const ci95Lower = sortedResults[Math.floor(totalSims * 0.025)];
            const ci95Upper = sortedResults[Math.floor(totalSims * 0.975)];
            
            return {
              prob1Plus: prob1Plus * 100,
              prob2Plus: prob2Plus * 100,
              prob3Plus: prob3Plus * 100,
              distribution,
              mean,
              median,
              ci95Lower,
              ci95Upper
            };
          }, [age, miiOocytes, selectedStudy, simulations]);

          return (
            <div className="max-w-6xl mx-auto p-6 bg-white">
              <div className="mb-8">
                <h1 className="text-3xl font-bold text-gray-900 mb-2">Oocyte Vitrification Calculator</h1>
                <p className="text-gray-600">Monte Carlo simulation based on published evidence</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div className="bg-gray-50 p-6 rounded-lg">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Age at Cryopreservation</label>
                  <input
                    type="range"
                    min="25"
                    max="43"
                    value={age}
                    onChange={(e) => setAge(parseInt(e.target.value))}
                    className="w-full"
                  />
                  <div className="text-center mt-2">
                    <span className="text-3xl font-bold text-blue-600">{age}</span>
                    <span className="text-gray-600 ml-2">years</span>
                  </div>
                </div>

                <div className="bg-gray-50 p-6 rounded-lg">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Number of MII Oocytes</label>
                  <input
                    type="range"
                    min="5"
                    max="50"
                    value={miiOocytes}
                    onChange={(e) => setMiiOocytes(parseInt(e.target.value))}
                    className="w-full"
                  />
                  <div className="text-center mt-2">
                    <span className="text-3xl font-bold text-green-600">{miiOocytes}</span>
                    <span className="text-gray-600 ml-2">oocytes</span>
                  </div>
                </div>

                <div className="bg-gray-50 p-6 rounded-lg">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Study Model</label>
                  <select
                    value={selectedStudy}
                    onChange={(e) => setSelectedStudy(e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded-lg"
                  >
                    <option value="namath">Namath et al. 2025</option>
                    <option value="cobo">Cobo et al. 2016</option>
                    <option value="doyle">Doyle et al. 2016</option>
                    <option value="goldman">Goldman et al. 2017</option>
                  </select>
                  <div className="text-xs text-gray-600 text-center mt-2">
                    {simulations.toLocaleString()} simulations
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div className="bg-green-50 border-2 border-green-300 p-4 rounded-lg text-center">
                  <div className="text-sm font-semibold text-green-700 mb-1">≥1 Live Birth</div>
                  <div className="text-3xl font-bold text-green-900">{simulationResults.prob1Plus.toFixed(1)}%</div>
                  <div className="text-xs text-gray-600 mt-1">Primary outcome</div>
                </div>

                <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-lg text-center">
                  <div className="text-sm font-semibold text-blue-700 mb-1">≥2 Live Births</div>
                  <div className="text-3xl font-bold text-blue-900">{simulationResults.prob2Plus.toFixed(1)}%</div>
                  <div className="text-xs text-gray-600 mt-1">Family building</div>
                </div>

                <div className="bg-purple-50 border-2 border-purple-300 p-4 rounded-lg text-center">
                  <div className="text-sm font-semibold text-purple-700 mb-1">≥3 Live Births</div>
                  <div className="text-3xl font-bold text-purple-900">{simulationResults.prob3Plus.toFixed(1)}%</div>
                  <div className="text-xs text-gray-600 mt-1">Extended family</div>
                </div>
              </div>

              <div className="bg-gray-100 p-4 rounded-lg mb-6">
                <div className="grid grid-cols-3 gap-4 text-center">
                  <div>
                    <div className="text-gray-600 text-sm">Mean</div>
                    <div className="font-bold text-lg">{simulationResults.mean.toFixed(2)}</div>
                  </div>
                  <div>
                    <div className="text-gray-600 text-sm">Median</div>
                    <div className="font-bold text-lg">{simulationResults.median}</div>
                  </div>
                  <div>
                    <div className="text-gray-600 text-sm">95% CI</div>
                    <div className="font-bold text-lg">{simulationResults.ci95Lower}-{simulationResults.ci95Upper}</div>
                  </div>
                </div>
              </div>

              <div className="text-xs text-gray-500 mt-6 border-t pt-4">
                <p><strong>Disclaimer:</strong> This calculator synthesizes published evidence for counseling purposes only. Individual outcomes vary based on clinic protocols and patient factors. Consult a reproductive endocrinologist for personalized advice.</p>
              </div>
            </div>
          );
        };

        ReactDOM.render(<OocyteCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
